Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.provideStructure = provideStructure;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _lodashTrim = require('lodash/trim');

var _lodashTrim2 = _interopRequireDefault(_lodashTrim);

var _utils = require('./utils');

var _tokenizer = require('./tokenizer');

'use babel';

var STRING = _tokenizer.TokenType.STRING;
var NULL = _tokenizer.TokenType.NULL;
var SYMBOL = _tokenizer.TokenType.SYMBOL;
var NUMBER = _tokenizer.TokenType.NUMBER;
var BEGIN_OBJECT = _tokenizer.TokenType.BEGIN_OBJECT;
var END_OBJECT = _tokenizer.TokenType.END_OBJECT;
var BEGIN_ARRAY = _tokenizer.TokenType.BEGIN_ARRAY;
var END_ARRAY = _tokenizer.TokenType.END_ARRAY;
var END_LABEL = _tokenizer.TokenType.END_LABEL;
var COMMA = _tokenizer.TokenType.COMMA;

function intersectsWithToken(position, token) {
  var tRow = token.line - 1;
  var pRow = position.row;
  var tCol = token.col;
  var tLength = token.src.length;
  var pCol = position.column;

  if (token.type === STRING) {
    return tRow === pRow && tCol <= pCol && tCol + tLength - 1 > pCol; // attention to ""
  }
  return tRow === pRow && tCol <= pCol && tCol + tLength > pCol;
}

function isBetweenTokenType(position, firstToken, secondToken) {
  var pRow = position.row;
  var pCol = position.column;
  var fRow = firstToken.line - 1;
  var sRow = secondToken.line - 1;
  var fEnd = firstToken.col + firstToken.src.length - 1;
  var sStart = secondToken.col;

  // cursor position and the 2 tokens are on the same line
  if (pRow === fRow && pRow === sRow) {
    return pCol >= fEnd && pCol < sStart;
  }
  // cursor position is not on the same line as the 2 other tokens but is between them
  return pRow > fRow && pRow < sRow || // firstToken \n+ position \n+ secondToken
  pRow === fRow && pRow < sRow && pCol >= fEnd // fistToken position \n+ secondToken
   || pRow > fRow && pRow === sRow && pCol < sStart; // firstToken \n+ position secondToken
}

function consumeValue(tokens, container, position, posInfo, posInfoHolder) {
  var valueStartToken = tokens.next();

  function checkPosition() {
    if (!posInfoHolder.hasValue() && intersectsWithToken(position, valueStartToken)) {
      var info = posInfo.setValuePosition().setEditedToken(valueStartToken).setPreviousToken(tokens.peekPrevious()).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
  }

  switch (valueStartToken.type) {
    case STRING:
      container.push((0, _lodashTrim2['default'])(valueStartToken.src, '"'));
      checkPosition();
      break;
    case NULL:
      container.push(null);
      checkPosition();
      break;
    case SYMBOL:
      container.push(undefined);
      checkPosition();
      break;
    case NUMBER:
      container.push(Number(valueStartToken.src));
      checkPosition();
      break;
    case BEGIN_OBJECT:
      var object = {};
      consumeObject(object, tokens, position, posInfo, posInfoHolder);
      container.push(object);
      break;
    case BEGIN_ARRAY:
      var array = [];
      consumeArray(array, tokens, position, posInfo, posInfoHolder);
      container.push(array);
      break;
    default:
      break;
  }
  return posInfo;
}

function consumeKeyValuePair(object, tokens, position, posInfo, posInfoHolder) {
  if (tokens.hasNext() && tokens.peekNext().type === END_OBJECT) {
    if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.current(), tokens.peekNext())) {
      var info = posInfo.setKeyPosition().setPreviousToken(tokens.current()).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
    return;
  }

  if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.current(), tokens.peekNext())) {
    var info = posInfo.setKeyPosition().setPreviousToken(tokens.current()).setNextToken(tokens.peekNext()).toObject();
    posInfoHolder.set(info);
  }

  var keyToken = tokens.next();
  // First token is not a key, skip it.
  if (keyToken.type !== STRING && keyToken.type !== SYMBOL) {
    return;
  }

  if (!posInfoHolder.hasValue() && intersectsWithToken(position, keyToken)) {
    var info = posInfo.setKeyPosition().setPreviousToken(tokens.peekPrevious()).setEditedToken(keyToken).setNextToken(tokens.peekNext()).toObject();
    posInfoHolder.set(info);
  }

  var key = (0, _lodashTrim2['default'])(keyToken.src, '"');
  var separatorToken = tokens.next();
  if (separatorToken.type === END_LABEL) {
    var pathWithKey = posInfo.add(key);
    if (!posInfoHolder.hasValue() && isBetweenTokenType(position, separatorToken, tokens.peekNext())) {
      var info = pathWithKey.setValuePosition().setPreviousToken(separatorToken).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
    // Complete key-value pair
    var valContainer = [];
    consumeValue(tokens, valContainer, position, pathWithKey, posInfoHolder);
    var value = valContainer[0];

    object[key] = value;
  } else {
    // separator in place, value probably under editing
    object[key] = undefined;
  }
}

function consumeObject(object, tokens, position, posInfo, posInfoHolder) {
  while (tokens.hasNext()) {
    consumeKeyValuePair(object, tokens, position, posInfo, posInfoHolder);
    if (tokens.hasNext()) {
      var token = tokens.next();
      switch (token.type) {
        case END_OBJECT:
          return; // end of object
        case COMMA:
          break; // ',' read - nothing else to do
        default:
          tokens.previous(); // something else, go back
      }
    }
  }
}

function consumeArray(array, tokens, position, posInfo, posInfoHolder) {
  var index = 0;
  while (tokens.hasNext()) {
    if (tokens.hasNext()) {
      var token = tokens.next();
      if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.peekPrevious(), token)) {
        var info = posInfo.add(index).setValuePosition().setPreviousToken(tokens.peekPrevious()).setNextToken(token).toObject();
        posInfoHolder.set(info);
      }
      switch (token.type) {
        case END_ARRAY:
          return; // end of array
        default:
          tokens.previous(); // something else, go back
      }
    }

    var valContainer = [];
    consumeValue(tokens, valContainer, position, posInfo.add(index), posInfoHolder);
    var value = valContainer[0];

    array.push(value);
    index++;

    if (tokens.hasNext()) {
      var token = tokens.next();
      if (!posInfoHolder.hasValue() && isBetweenTokenType(position, token, tokens.peekNext())) {
        var info = posInfo.add(index).setValuePosition().setPreviousToken(token).setNextToken(tokens.peekNext()).toObject();
        posInfoHolder.set(info);
      }
      switch (token.type) {
        case END_ARRAY:
          return; // end of object
        case COMMA:
          break; // ',' read - nothing else to do
        default:
          tokens.previous(); // something else, go back
      }
    }
  }
}

function provideStructure(tokensArray, position) {
  var tokens = new _utils.ArrayTraverser(tokensArray);

  if (!tokens.hasNext()) {
    return { contents: null, positionInfo: null, tokens: tokensArray }; // no tokens
  }

  var posInfoHolder = new _utils.ValueHolder();
  var firstToken = tokens.next();
  if (firstToken.type === BEGIN_OBJECT) {
    var object = {};
    consumeObject(object, tokens, position, new _utils.PositionInfo(), posInfoHolder);
    return { contents: object, positionInfo: posInfoHolder.getOrElse(null), tokens: tokensArray };
  } else if (firstToken.type === BEGIN_ARRAY) {
    var array = [];
    consumeArray(array, tokens, position, new _utils.PositionInfo(), posInfoHolder);
    return { contents: array, positionInfo: posInfoHolder.getOrElse(null), tokens: tokensArray };
  }
  return { contents: null, positionInfo: null, tokens: tokensArray }; // don't bother with strings, numbers, etc. for now
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3lvc2hpbm9yaXlhbWFndWNoaS9kb3RmaWxlcy8uYXRvbS9wYWNrYWdlcy9hdXRvY29tcGxldGUtanNvbi9zcmMvc3RydWN0dXJlLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7MEJBRWlCLGFBQWE7Ozs7cUJBQzRCLFNBQVM7O3lCQUN6QyxhQUFhOztBQUp2QyxXQUFXLENBQUE7O0lBTUgsTUFBTSx3QkFBTixNQUFNO0lBQUUsSUFBSSx3QkFBSixJQUFJO0lBQUUsTUFBTSx3QkFBTixNQUFNO0lBQUUsTUFBTSx3QkFBTixNQUFNO0lBQUUsWUFBWSx3QkFBWixZQUFZO0lBQUUsVUFBVSx3QkFBVixVQUFVO0lBQUUsV0FBVyx3QkFBWCxXQUFXO0lBQUUsU0FBUyx3QkFBVCxTQUFTO0lBQUUsU0FBUyx3QkFBVCxTQUFTO0lBQUUsS0FBSyx3QkFBTCxLQUFLOztBQUV4RyxTQUFTLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUU7QUFDNUMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUE7QUFDM0IsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQTtBQUN6QixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFBO0FBQ3RCLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFBO0FBQ2hDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUE7O0FBRTVCLE1BQUksS0FBSyxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7QUFDekIsV0FBTyxJQUFJLEtBQUssSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLE9BQU8sR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFBO0dBQ2xFO0FBQ0QsU0FBTyxJQUFJLEtBQUssSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLE9BQU8sR0FBRyxJQUFJ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aEIsZ0JBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSx5QkFBa0IsRUFBRSxhQUFhLENBQUMsQ0FBQTtBQUN4RSxXQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUE7R0FDN0Y7QUFDRCxTQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQTtDQUNuRSIsImZpbGUiOiIvaG9tZS95b3NoaW5vcml5YW1hZ3VjaGkvZG90ZmlsZXMvLmF0b20vcGFja2FnZXMvYXV0b2NvbXBsZXRlLWpzb24vc3JjL3N0cnVjdHVyZS1wcm92aWRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnXG5cbmltcG9ydCB0cmltIGZyb20gJ2xvZGFzaC90cmltJ1xuaW1wb3J0IHsgQXJyYXlUcmF2ZXJzZXIsIFBvc2l0aW9uSW5mbywgVmFsdWVIb2xkZXIgfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHsgVG9rZW5UeXBlIH0gZnJvbSAnLi90b2tlbml6ZXInXG5cbmNvbnN0IHsgU1RSSU5HLCBOVUxMLCBTWU1CT0wsIE5VTUJFUiwgQkVHSU5fT0JKRUNULCBFTkRfT0JKRUNULCBCRUdJTl9BUlJBWSwgRU5EX0FSUkFZLCBFTkRfTEFCRUwsIENPTU1BIH0gPSBUb2tlblR5cGVcblxuZnVuY3Rpb24gaW50ZXJzZWN0c1dpdGhUb2tlbihwb3NpdGlvbiwgdG9rZW4pIHtcbiAgY29uc3QgdFJvdyA9IHRva2VuLmxpbmUgLSAxXG4gIGNvbnN0IHBSb3cgPSBwb3NpdGlvbi5yb3dcbiAgY29uc3QgdENvbCA9IHRva2VuLmNvbFxuICBjb25zdCB0TGVuZ3RoID0gdG9rZW4uc3JjLmxlbmd0aFxuICBjb25zdCBwQ29sID0gcG9zaXRpb24uY29sdW1uXG5cbiAgaWYgKHRva2VuLnR5cGUgPT09IFNUUklORykge1xuICAgIHJldHVybiB0Um93ID09PSBwUm93ICYmIHRDb2wgPD0gcENvbCAmJiB0Q29sICsgdExlbmd0aCAtIDEgPiBwQ29sIC8vIGF0dGVudGlvbiB0byBcIlwiXG4gIH1cbiAgcmV0dXJuIHRSb3cgPT09IHBSb3cgJiYgdENvbCA8PSBwQ29sICYmIHRDb2wgKyB0TGVuZ3RoID4gcENvbFxuXG59XG5cbmZ1bmN0aW9uIGlzQmV0d2VlblRva2VuVHlwZShwb3NpdGlvbiwgZmlyc3RUb2tlbiwgc2Vjb25kVG9rZW4pIHtcbiAgY29uc3QgcFJvdyA9IHBvc2l0aW9uLnJvd1xuICBjb25zdCBwQ29sID0gcG9zaXRpb24uY29sdW1uXG4gIGNvbnN0IGZSb3cgPSBmaXJzdFRva2VuLmxpbmUgLSAxXG4gIGNvbnN0IHNSb3cgPSBzZWNvbmRUb2tlbi5saW5lIC0gMVxuICBjb25zdCBmRW5kID0gZmlyc3RUb2tlbi5jb2wgKyBmaXJzdFRva2VuLnNyYy5sZW5ndGggLSAxXG4gIGNvbnN0IHNTdGFydCA9IHNlY29uZFRva2VuLmNvbFxuXG4gIC8vIGN1cnNvciBwb3NpdGlvbiBhbmQgdGhlIDIgdG9rZW5zIGFyZSBvbiB0aGUgc2FtZSBsaW5lXG4gIGlmIChwUm93ID09PSBmUm93ICYmIHBSb3cgPT09IHNSb3cpIHtcbiAgICByZXR1cm4gcENvbCA+PSBmRW5kICYmIHBDb2wgPCBzU3RhcnRcbiAgfVxuICAvLyBjdXJzb3IgcG9zaXRpb24gaXMgbm90IG9uIHRoZSBzYW1lIGxpbmUgYXMgdGhlIDIgb3RoZXIgdG9rZW5zIGJ1dCBpcyBiZXR3ZWVuIHRoZW1cbiAgcmV0dXJuIChwUm93ID4gZlJvdyAmJiBwUm93IDwgc1JvdykgLy8gZmlyc3RUb2tlbiBcXG4rIHBvc2l0aW9uIFxcbisgc2Vjb25kVG9rZW5cbiAgICB8fCAocFJvdyA9PT0gZlJvdyAmJiBwUm93IDwgc1JvdyAmJiBwQ29sID49IGZFbmQpIC8vIGZpc3RUb2tlbiBwb3NpdGlvbiBcXG4rIHNlY29uZFRva2VuXG4gICAgfHwgKHBSb3cgPiBmUm93ICYmIHBSb3cgPT09IHNSb3cgJiYgcENvbCA8IHNTdGFydCkgLy8gZmlyc3RUb2tlbiBcXG4rIHBvc2l0aW9uIHNlY29uZFRva2VuXG59XG5cbmZ1bmN0aW9uIGNvbnN1bWVWYWx1ZSh0b2tlbnMsIGNvbnRhaW5lciwgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpIHtcbiAgY29uc3QgdmFsdWVTdGFydFRva2VuID0gdG9rZW5zLm5leHQoKVxuXG4gIGZ1bmN0aW9uIGNoZWNrUG9zaXRpb24oKSB7XG4gICAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaW50ZXJzZWN0c1dpdGhUb2tlbihwb3NpdGlvbiwgdmFsdWVTdGFydFRva2VuKSkge1xuICAgICAgY29uc3QgaW5mbyA9IHBvc0luZm8uc2V0VmFsdWVQb3NpdGlvbigpXG4gICAgICAgIC5zZXRFZGl0ZWRUb2tlbih2YWx1ZVN0YXJ0VG9rZW4pXG4gICAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHRva2Vucy5wZWVrUHJldmlvdXMoKSlcbiAgICAgICAgLnNldE5leHRUb2tlbih0b2tlbnMucGVla05leHQoKSlcbiAgICAgICAgLnRvT2JqZWN0KClcbiAgICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gICAgfVxuICB9XG5cbiAgc3dpdGNoICh2YWx1ZVN0YXJ0VG9rZW4udHlwZSkge1xuICAgIGNhc2UgU1RSSU5HOlxuICAgICAgY29udGFpbmVyLnB1c2godHJpbSh2YWx1ZVN0YXJ0VG9rZW4uc3JjLCAnXCInKSlcbiAgICAgIGNoZWNrUG9zaXRpb24oKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIE5VTEw6XG4gICAgICBjb250YWluZXIucHVzaChudWxsKVxuICAgICAgY2hlY2tQb3NpdGlvbigpXG4gICAgICBicmVha1xuICAgIGNhc2UgU1lNQk9MOlxuICAgICAgY29udGFpbmVyLnB1c2godW5kZWZpbmVkKVxuICAgICAgY2hlY2tQb3NpdGlvbigpXG4gICAgICBicmVha1xuICAgIGNhc2UgTlVNQkVSOlxuICAgICAgY29udGFpbmVyLnB1c2goTnVtYmVyKHZhbHVlU3RhcnRUb2tlbi5zcmMpKVxuICAgICAgY2hlY2tQb3NpdGlvbigpXG4gICAgICBicmVha1xuICAgIGNhc2UgQkVHSU5fT0JKRUNUOlxuICAgICAgY29uc3Qgb2JqZWN0ID0ge31cbiAgICAgIGNvbnN1bWVPYmplY3Qob2JqZWN0LCB0b2tlbnMsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKVxuICAgICAgY29udGFpbmVyLnB1c2gob2JqZWN0KVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEJFR0lOX0FSUkFZOlxuICAgICAgY29uc3QgYXJyYXkgPSBbXVxuICAgICAgY29uc3VtZUFycmF5KGFycmF5LCB0b2tlbnMsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKVxuICAgICAgY29udGFpbmVyLnB1c2goYXJyYXkpXG4gICAgICBicmVha1xuICAgIGRlZmF1bHQ6IGJyZWFrXG4gIH1cbiAgcmV0dXJuIHBvc0luZm9cbn1cblxuZnVuY3Rpb24gY29uc3VtZUtleVZhbHVlUGFpcihvYmplY3QsIHRva2VucywgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpIHtcbiAgaWYgKHRva2Vucy5oYXNOZXh0KCkgJiYgdG9rZW5zLnBlZWtOZXh0KCkudHlwZSA9PT0gRU5EX09CSkVDVCkge1xuICAgIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGlzQmV0d2VlblRva2VuVHlwZShwb3NpdGlvbiwgdG9rZW5zLmN1cnJlbnQoKSwgdG9rZW5zLnBlZWtOZXh0KCkpKSB7XG4gICAgICBjb25zdCBpbmZvID0gcG9zSW5mby5zZXRLZXlQb3NpdGlvbigpXG4gICAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHRva2Vucy5jdXJyZW50KCkpXG4gICAgICAgIC5zZXROZXh0VG9rZW4odG9rZW5zLnBlZWtOZXh0KCkpXG4gICAgICAgIC50b09iamVjdCgpXG4gICAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICAgIH1cbiAgICByZXR1cm5cbiAgfVxuXG4gIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGlzQmV0d2VlblRva2VuVHlwZShwb3NpdGlvbiwgdG9rZW5zLmN1cnJlbnQoKSwgdG9rZW5zLnBlZWtOZXh0KCkpKSB7XG4gICAgY29uc3QgaW5mbyA9IHBvc0luZm8uc2V0S2V5UG9zaXRpb24oKVxuICAgICAgLnNldFByZXZpb3VzVG9rZW4odG9rZW5zLmN1cnJlbnQoKSlcbiAgICAgIC5zZXROZXh0VG9rZW4odG9rZW5zLnBlZWtOZXh0KCkpXG4gICAgICAudG9PYmplY3QoKVxuICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gIH1cblxuICBjb25zdCBrZXlUb2tlbiA9IHRva2Vucy5uZXh0KClcbiAgLy8gRmlyc3QgdG9rZW4gaXMgbm90IGEga2V5LCBza2lwIGl0LlxuICBpZiAoa2V5VG9rZW4udHlwZSAhPT0gU1RSSU5HICYmIGtleVRva2VuLnR5cGUgIT09IFNZTUJPTCkge1xuICAgIHJldHVyblxuICB9XG5cbiAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaW50ZXJzZWN0c1dpdGhUb2tlbihwb3NpdGlvbiwga2V5VG9rZW4pKSB7XG4gICAgY29uc3QgaW5mbyA9IHBvc0luZm8uc2V0S2V5UG9zaXRpb24oKVxuICAgICAgLnNldFByZXZpb3VzVG9rZW4odG9rZW5zLnBlZWtQcmV2aW91cygpKVxuICAgICAgLnNldEVkaXRlZFRva2VuKGtleVRva2VuKVxuICAgICAgLnNldE5leHRUb2tlbih0b2tlbnMucGVla05leHQoKSlcbiAgICAgIC50b09iamVjdCgpXG4gICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgfVxuXG4gIGNvbnN0IGtleSA9IHRyaW0oa2V5VG9rZW4uc3JjLCAnXCInKVxuICBjb25zdCBzZXBhcmF0b3JUb2tlbiA9IHRva2Vucy5uZXh0KClcbiAgaWYgKHNlcGFyYXRvclRva2VuLnR5cGUgPT09IEVORF9MQUJFTCkge1xuICAgIGNvbnN0IHBhdGhXaXRoS2V5ID0gcG9zSW5mby5hZGQoa2V5KVxuICAgIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGlzQmV0d2VlblRva2VuVHlwZShwb3NpdGlvbiwgc2VwYXJhdG9yVG9rZW4sIHRva2Vucy5wZWVrTmV4dCgpKSkge1xuICAgICAgY29uc3QgaW5mbyA9IHBhdGhXaXRoS2V5LnNldFZhbHVlUG9zaXRpb24oKVxuICAgICAgICAuc2V0UHJldmlvdXNUb2tlbihzZXBhcmF0b3JUb2tlbilcbiAgICAgICAgLnNldE5leHRUb2tlbih0b2tlbnMucGVla05leHQoKSlcbiAgICAgICAgLnRvT2JqZWN0KClcbiAgICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gICAgfVxuICAgIC8vIENvbXBsZXRlIGtleS12YWx1ZSBwYWlyXG4gICAgY29uc3QgdmFsQ29udGFpbmVyID0gW11cbiAgICBjb25zdW1lVmFsdWUodG9rZW5zLCB2YWxDb250YWluZXIsIHBvc2l0aW9uLCBwYXRoV2l0aEtleSwgcG9zSW5mb0hvbGRlcilcbiAgICBjb25zdCBbdmFsdWVdID0gdmFsQ29udGFpbmVyXG4gICAgb2JqZWN0W2tleV0gPSB2YWx1ZVxuICB9IGVsc2Uge1xuICAgIC8vIHNlcGFyYXRvciBpbiBwbGFjZSwgdmFsdWUgcHJvYmFibHkgdW5kZXIgZWRpdGluZ1xuICAgIG9iamVjdFtrZXldID0gdW5kZWZpbmVkXG4gIH1cbn1cblxuZnVuY3Rpb24gY29uc3VtZU9iamVjdChvYmplY3QsIHRva2VucywgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpIHtcbiAgd2hpbGUgKHRva2Vucy5oYXNOZXh0KCkpIHtcbiAgICBjb25zdW1lS2V5VmFsdWVQYWlyKG9iamVjdCwgdG9rZW5zLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcilcbiAgICBpZiAodG9rZW5zLmhhc05leHQoKSkge1xuICAgICAgY29uc3QgdG9rZW4gPSB0b2tlbnMubmV4dCgpXG4gICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHtcbiAgICAgICAgY2FzZSBFTkRfT0JKRUNUOiByZXR1cm4gLy8gZW5kIG9mIG9iamVjdFxuICAgICAgICBjYXNlIENPTU1BOiBicmVhayAvLyAnLCcgcmVhZCAtIG5vdGhpbmcgZWxzZSB0byBkb1xuICAgICAgICBkZWZhdWx0OiB0b2tlbnMucHJldmlvdXMoKSAvLyBzb21ldGhpbmcgZWxzZSwgZ28gYmFja1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBjb25zdW1lQXJyYXkoYXJyYXksIHRva2VucywgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpIHtcbiAgbGV0IGluZGV4ID0gMFxuICB3aGlsZSAodG9rZW5zLmhhc05leHQoKSkge1xuICAgIGlmICh0b2tlbnMuaGFzTmV4dCgpKSB7XG4gICAgICBjb25zdCB0b2tlbiA9IHRva2Vucy5uZXh0KClcbiAgICAgIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGlzQmV0d2VlblRva2VuVHlwZShwb3NpdGlvbiwgdG9rZW5zLnBlZWtQcmV2aW91cygpLCB0b2tlbikpIHtcbiAgICAgICAgY29uc3QgaW5mbyA9IHBvc0luZm8uYWRkKGluZGV4KVxuICAgICAgICAgIC5zZXRWYWx1ZVBvc2l0aW9uKClcbiAgICAgICAgICAuc2V0UHJldmlvdXNUb2tlbih0b2tlbnMucGVla1ByZXZpb3VzKCkpXG4gICAgICAgICAgLnNldE5leHRUb2tlbih0b2tlbilcbiAgICAgICAgICAudG9PYmplY3QoKVxuICAgICAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICAgICAgfVxuICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7XG4gICAgICAgIGNhc2UgRU5EX0FSUkFZOiByZXR1cm4gLy8gZW5kIG9mIGFycmF5XG4gICAgICAgIGRlZmF1bHQ6IHRva2Vucy5wcmV2aW91cygpIC8vIHNvbWV0aGluZyBlbHNlLCBnbyBiYWNrXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgdmFsQ29udGFpbmVyID0gW11cbiAgICBjb25zdW1lVmFsdWUodG9rZW5zLCB2YWxDb250YWluZXIsIHBvc2l0aW9uLCBwb3NJbmZvLmFkZChpbmRleCksIHBvc0luZm9Ib2xkZXIpXG4gICAgY29uc3QgW3ZhbHVlXSA9IHZhbENvbnRhaW5lclxuICAgIGFycmF5LnB1c2godmFsdWUpXG4gICAgaW5kZXgrK1xuXG4gICAgaWYgKHRva2Vucy5oYXNOZXh0KCkpIHtcbiAgICAgIGNvbnN0IHRva2VuID0gdG9rZW5zLm5leHQoKVxuICAgICAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaXNCZXR3ZWVuVG9rZW5UeXBlKHBvc2l0aW9uLCB0b2tlbiwgdG9rZW5zLnBlZWtOZXh0KCkpKSB7XG4gICAgICAgIGNvbnN0IGluZm8gPSBwb3NJbmZvLmFkZChpbmRleClcbiAgICAgICAgICAuc2V0VmFsdWVQb3NpdGlvbigpXG4gICAgICAgICAgLnNldFByZXZpb3VzVG9rZW4odG9rZW4pXG4gICAgICAgICAgLnNldE5leHRUb2tlbih0b2tlbnMucGVla05leHQoKSlcbiAgICAgICAgICAudG9PYmplY3QoKVxuICAgICAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICAgICAgfVxuICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7XG4gICAgICAgIGNhc2UgRU5EX0FSUkFZOiByZXR1cm4gLy8gZW5kIG9mIG9iamVjdFxuICAgICAgICBjYXNlIENPTU1BOiBicmVhayAvLyAnLCcgcmVhZCAtIG5vdGhpbmcgZWxzZSB0byBkb1xuICAgICAgICBkZWZhdWx0OiB0b2tlbnMucHJldmlvdXMoKSAvLyBzb21ldGhpbmcgZWxzZSwgZ28gYmFja1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZVN0cnVjdHVyZSh0b2tlbnNBcnJheSwgcG9zaXRpb24pIHtcbiAgY29uc3QgdG9rZW5zID0gbmV3IEFycmF5VHJhdmVyc2VyKHRva2Vuc0FycmF5KVxuXG4gIGlmICghdG9rZW5zLmhhc05leHQoKSkge1xuICAgIHJldHVybiB7IGNvbnRlbnRzOiBudWxsLCBwb3NpdGlvbkluZm86IG51bGwsIHRva2VuczogdG9rZW5zQXJyYXkgfSAvLyBubyB0b2tlbnNcbiAgfVxuXG4gIGNvbnN0IHBvc0luZm9Ib2xkZXIgPSBuZXcgVmFsdWVIb2xkZXIoKVxuICBjb25zdCBmaXJzdFRva2VuID0gdG9rZW5zLm5leHQoKVxuICBpZiAoZmlyc3RUb2tlbi50eXBlID09PSBCRUdJTl9PQkpFQ1QpIHtcbiAgICBjb25zdCBvYmplY3QgPSB7fVxuICAgIGNvbnN1bWVPYmplY3Qob2JqZWN0LCB0b2tlbnMsIHBvc2l0aW9uLCBuZXcgUG9zaXRpb25JbmZvKCksIHBvc0luZm9Ib2xkZXIpXG4gICAgcmV0dXJuIHsgY29udGVudHM6IG9iamVjdCwgcG9zaXRpb25JbmZvOiBwb3NJbmZvSG9sZGVyLmdldE9yRWxzZShudWxsKSwgdG9rZW5zOiB0b2tlbnNBcnJheSB9XG4gIH0gZWxzZSBpZiAoZmlyc3RUb2tlbi50eXBlID09PSBCRUdJTl9BUlJBWSkge1xuICAgIGNvbnN0IGFycmF5ID0gW11cbiAgICBjb25zdW1lQXJyYXkoYXJyYXksIHRva2VucywgcG9zaXRpb24sIG5ldyBQb3NpdGlvbkluZm8oKSwgcG9zSW5mb0hvbGRlcilcbiAgICByZXR1cm4geyBjb250ZW50czogYXJyYXksIHBvc2l0aW9uSW5mbzogcG9zSW5mb0hvbGRlci5nZXRPckVsc2UobnVsbCksIHRva2VuczogdG9rZW5zQXJyYXkgfVxuICB9XG4gIHJldHVybiB7IGNvbnRlbnRzOiBudWxsLCBwb3NpdGlvbkluZm86IG51bGwsIHRva2VuczogdG9rZW5zQXJyYXkgfSAvLyBkb24ndCBib3RoZXIgd2l0aCBzdHJpbmdzLCBudW1iZXJzLCBldGMuIGZvciBub3dcbn1cbiJdfQ==